<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·Ÿè‘— aespa ç’°éŠä¸–ç•Œ</title>
    <style>
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f4f4;
        }
        
        #app-container {
            height: 100%; /* ä½”æ»¿ body é«˜åº¦ */
            display: flex;
            max-height: 100vh; 
            overflow: hidden; 
        }
        
        #map {
            flex-grow: 1; /* åœ°åœ–ä½”æ“šå‰©é¤˜ç©ºé–“ */
            min-height: 50vh; 
            min-width: 0;
        }
        
        #sidebar {
            width: 40%;
            max-height: 100vh;
            overflow-y: auto; 
            background-color: white;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        
        h2 { color: #5a5a5a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .location-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            
            /* ç¢ºä¿å¯¬åº¦åˆ†é…å¯ä»¥é‹ä½œ */
            display: flex;
            justify-content: space-between; /* æ–‡å­—é å·¦ï¼Œåœ–ç‰‡é å³ */
            align-items: flex-start; /* é ‚éƒ¨å°é½Š */
        }
        .card-text-content {
        /* è¨­ç½®å›ºå®šå¯¬åº¦æ¯”ä¾‹ï¼Œä½¿å…¶èˆ‡åœ–ç‰‡åˆ†é…ç©ºé–“ */
            width: 60%; 
            flex-grow: 0; 
            flex-shrink: 0; /* é˜»æ­¢æ–‡å­—å€å¡Šè¢«åœ–ç‰‡æ“ å£“ */
            margin-right: 15px;
            /* ç¢ºä¿é•·æ¨™é¡Œèƒ½æ›è¡Œ */
            overflow-wrap: break-word; 
            word-wrap: break-word;
        }
        .location-card:hover {
            background-color: #f9f9f9;
        }
        .location-card strong { 
            display: block; 
            font-size: 20px; /* å¢å¤§æ¨™é¡Œå­—é«” */
            margin-bottom: 5px; 
            color: #333; 
            /* ç¢ºä¿é•·æ¨™é¡Œèƒ½æ›è¡Œ */
            overflow-wrap: break-word; 
            word-wrap: break-word;
        }
        .location-card img {
            width: 35%; /* ç¢ºä¿ç¸½å’Œ (60% + 35%) < 100%ï¼Œç•™ä¸‹ margin ç©ºé–“ */
            height: auto;
            object-fit: contain; /* ç¢ºä¿åœ–ç‰‡ä¸è¢«æ‹‰ä¼¸ï¼Œå¡«æ»¿å®¹å™¨ */
            flex-shrink: 0; /* é˜²æ­¢åœ–ç‰‡è¢«å£“ç¸® */
            border-radius: 4px;
            margin: 0; 
            /* ç¢ºä¿åœ–ç‰‡ä¸æœƒè¶…å‡ºå®¹å™¨çš„ max-width */
            max-width: 100%;
        }
        .card-line {
            display: block;
            font-size: 18px;
            color: #666;
            line-height: 1.4;
        }

        .card-link{
            display: block;
            margin-top: 6px;
            font-size: 18px;     
            line-height: 1.4;
        }
        .info-window-content{
            font-size: 20px;    
        }
        .info-window-line{
            font-size: 18px;    
        }


        /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼šé‡å°æ‰‹æ©Ÿè¢å¹• */
        @media (max-width: 768px) {
            #app-container {
                flex-direction: column; 
                height: auto;
            }
            #sidebar {
                width: auto;
                max-height: 45vh; 
                order: 2; 
            }
            #map {
                height: 55vh; 
                order: 1;
            }
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="map"></div>

    <div id="sidebar">
        <h2>è·Ÿè‘— aespa ç’°éŠä¸–ç•Œ (ç›®å‰å…± <span id="location-count">0</span> è™•)</h2>
        
        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <label for="member-filter" style="font-weight: bold;">ä¾æˆå“¡ç¯©é¸ï¼š</label>
            <select id="member-filter" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px;">
                <option value="All">å…¨éƒ¨æˆå“¡</option>
            </select>
            
            <label for="country-filter" style="font-weight: bold; display: block; margin-top: 10px;">åœ‹å®¶:</label>
            <select id="country-filter" onchange="handleCountryChange()" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px;">
                <option value="">æ‰€æœ‰åœ‹å®¶</option>
            </select>

            <label for="city-filter" style="font-weight: bold; display: block; margin-top: 10px;">åœ°å€/åŸå¸‚:</label>
            <select id="city-filter" onchange="filterLocations()" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px;">
                <option value="">æ‰€æœ‰åœ°å€/åŸå¸‚</option>
            </select>

            <button onclick="resetFilters()" style="margin-top: 10px; padding: 8px 15px; width: 100%; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¨­ç¯©é¸</button>
        </div>
        <div id="locations-list">
        </div>
    </div>
</div>

<script>
    /**
     * ç¶å®šè¼ªæ’­å®¹å™¨çš„é»æ“Šäº‹ä»¶
     */
    function bindCarouselEvents() {
        document.querySelectorAll('.image-carousel').forEach(carousel => {
            carousel.addEventListener('click', (event) => {
                // é˜»æ­¢é»æ“Šäº‹ä»¶å‘ä¸Šå‚³æ’­åˆ°å¡ç‰‡æœ¬èº« (é˜²æ­¢è§¸ç™¼åœ°åœ–å®šä½)
                event.stopPropagation(); 
                
                const locationIndex = parseInt(carousel.dataset.locationIndex);
                const locationData = locationsData[locationIndex];
                const imageUrls = locationData.ig_img_urls;
                
                if (imageUrls.length <= 1) return; // å–®å¼µåœ–ç‰‡å‰‡ç„¡éœ€åˆ‡æ›

                let currentIndex = parseInt(carousel.dataset.currentImg);
                
                // è¨ˆç®—ä¸‹ä¸€å¼µåœ–ç‰‡çš„ç´¢å¼• (å¾ªç’°åˆ‡æ›)
                currentIndex = (currentIndex + 1) % imageUrls.length;
                
                // æ›´æ–°åœ–ç‰‡æº (src)
                const imgElement = carousel.querySelector('img');
                imgElement.src = imageUrls[currentIndex];
                
                // æ›´æ–°æ•¸æ“šå±¬æ€§
                carousel.dataset.currentImg = currentIndex;
            });
        });
    }
    // =================================================================
    // æˆå“¡é¡è‰²å®šç¾©
    // =================================================================
    const MEMBER_INFO = {
        "Karina": { color: "blue", symbol: "ğŸ’™" }, // æ„›å¿ƒ
        "Giselle": { color: "pink", symbol: "ğŸŒ™" }, // æœˆäº®
        "Winter": { color: "white", symbol: "â­" }, // æ˜Ÿæ˜Ÿ
        "Ningning": { color: "purple", symbol: "ğŸ¦‹" }, // è´è¶
        "Default": { color: "orange", symbol: "ğŸ”®" } // ç”¨æ–¼å¤šæˆå“¡
    };
    // =================================================================
    // 1. æ•¸æ“šå®£å‘Š (è®Šç‚ºç©ºé™£åˆ—ï¼Œç­‰å¾…å¾ JSON æª”æ¡ˆè¼‰å…¥)
    // =================================================================
    let locationsData = [];

    // =================================================================
    // 2. Google Maps åˆå§‹åŒ–èˆ‡æ¨™è¨˜åŠŸèƒ½
    // =================================================================
    let map;
    let infoWindow; 

    /**
     * è¼‰å…¥æ•¸æ“šä¸¦åˆå§‹åŒ–åœ°åœ–çš„ä¸»è¦å‡½å¼ 
     */
    async function loadDataAndInitMap() {
        try {
            // 1. ä½¿ç”¨ Fetch API è®€å– locations.json æª”æ¡ˆ
            const response = await fetch('locations.json'); 
            locationsData = await response.json(); // å°‡ JSON æ•¸æ“šè³¦å€¼çµ¦ locationsData é™£åˆ—

            // 2. åˆå§‹åŒ–åœ°åœ– (åŸ initMap å…§çš„é‚è¼¯)
            infoWindow = new google.maps.InfoWindow(); 
            const bounds = new google.maps.LatLngBounds(); 
            const initialCenter = { lat: 35.6762, lng: 139.6503 }; 
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: initialCenter,
                mapTypeId: 'roadmap',
                // é€™è£¡å¯ä»¥è²¼å…¥æ‚¨æœ€å¾Œç¢ºèªæœ‰æ•ˆçš„ styles é™£åˆ—
                styles: [
                    { featureType: "poi", stylers: [{ visibility: "off" }] },
                    { featureType: "transit", elementType: "labels", stylers: [{ visibility: "off" }] }
                ]
            });
            
            locationsData.forEach(location => {
                addMarker(location);
                bounds.extend({ lat: location.lat, lng: location.lng });
            });
            
            if (locationsData.length > 0) {
                if (locationsData.length === 1) {
                    map.setCenter({ lat: locationsData[0].lat, lng: locationsData[0].lng });
                    map.setZoom(12);
                } else {
                    map.fitBounds(bounds);
                }
            }
            
            google.maps.event.trigger(map, 'resize');
            
            // 3. è™•ç†ç¯©é¸å’Œåˆ—è¡¨ (ç¢ºä¿å®ƒå€‘åœ¨æ•¸æ“šè¼‰å…¥å¾ŒåŸ·è¡Œ)
            document.getElementById('location-count').textContent = locationsData.length;
            renderSidebarList();
            initFilters(); 

        } catch (error) {
            console.error("âŒ è¼‰å…¥æ•¸æ“šæˆ–åˆå§‹åŒ–åœ°åœ–å¤±æ•—ï¼", error);
            // å¯ä»¥åœ¨åœ°åœ–æˆ–å´é‚Šæ¬„é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        }
    }

    /**
     * æ ¹æ“šæˆå“¡åç¨±ç²å–é¡è‰²å’Œç¬¦è™Ÿè³‡è¨Š
     * @param {Array<string>} members - åœ°é»ç›¸é—œçš„æˆå“¡åˆ—è¡¨
     * @returns {Object} åŒ…å« color å’Œ symbol çš„ç‰©ä»¶
     */
    function getMemberInfo(members) {
        // å¦‚æœåªæœ‰ä¸€ä½æˆå“¡ï¼Œè¿”å›è©²æˆå“¡çš„é¡è‰²å’Œç¬¦è™Ÿ
        if (members.length === 1) {
            const member = members[0].trim();
            return MEMBER_INFO[member] || MEMBER_INFO.Default;
        }
        // å¦‚æœæ˜¯å¤šä½æˆå“¡æˆ–æˆå“¡åˆ—è¡¨ç‚ºç©ºï¼Œå‰‡è¿”å›é è¨­è‰²
        return MEMBER_INFO.Default;
    }

    /**
     * åœ¨åœ°åœ–ä¸Šæ”¾ç½®ä¸€å€‹æ¨™è¨˜ (ä½¿ç”¨é è¨­æ¨™è¨˜)
     * @param {Object} location - åœ°é»æ•¸æ“šç‰©ä»¶
     */
    function addMarker(location) {
        const marker = new google.maps.Marker({
            position: { lat: location.lat, lng: location.lng },
            map: map,
            title: location.name
        });

        const imageUrls = location.ig_img_urls || [];
        const firstImageUrl = imageUrls.length > 0 ? imageUrls[0] : '';
        const isImageValid = firstImageUrl && firstImageUrl !== 'è«‹è‡ªè¡Œå°‹æ‰¾ç…§ç‰‡ URL';
        
        // ç²å–æ‰€æœ‰æˆå“¡çš„è³‡è¨Š (ç”¨æ–¼ InfoWindow)
        const membersWithSymbols = location.members.map(member => {
            const info = MEMBER_INFO[member.trim()] || MEMBER_INFO.Default;
            // é¡¯ç¤ºç‚ºï¼š ğŸ’™ Karina
            return `${info.symbol} ${member.trim()}`;
        }).join('<br>'); // ä½¿ç”¨ <br> è®“å¤šå€‹æˆå“¡åœ¨ InfoWindow ä¸­æ›è¡Œ

        // é»æ“Šæ¨™è¨˜æ™‚ï¼Œé¡¯ç¤ºè³‡è¨Šè¦–çª—
        marker.addListener("click", () => {
            
            const content = `
                <div class="info-window-content">
                    
                    ${isImageValid 
                        ? `<img src="${firstImageUrl}" alt="${location.name} é è¦½åœ–" style="max-width: 250px; height: auto; margin-bottom: 10px; border-radius: 4px;">`
                        : ''}
                    
                    <h4>${location.name}</h4>
                    <div class="info-window-line"><strong>æˆå“¡ï¼š</strong><br> ${membersWithSymbols}</div> 
                    <div class="info-window-line"><strong>ç™¼æ–‡æ—¥æœŸï¼š</strong> ${location.date}</div>
                    <div class="info-window-line"><strong>å‚™è¨»ï¼š</strong> ${location.note}</div>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
            
            const cardElement = document.getElementById(`card-${location.lat}-${location.lng}`);
            if (cardElement) {
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
        
        location.marker = marker;
    }

    // =================================================================
    // 3. å´é‚Šæ¬„åˆ—è¡¨æ¸²æŸ“ 
    // =================================================================
    function renderSidebarList() {
        const listContainer = document.getElementById('locations-list');
        listContainer.innerHTML = ''; 

        locationsData.forEach((location, index) => { // åŠ å…¥ index 
            const card = document.createElement('div');
            card.id = `card-${location.lat}-${location.lng}`; 
            card.className = 'location-card';
            
            const symbolsArray = location.members.map(member => {
                const info = getMemberInfo([member]);
                return info.symbol;
            });
            const symbolDisplay = symbolsArray.join(' '); 
            // ------------------------------------
            
            // ç²å–åœ–ç‰‡é™£åˆ—
            const imageUrls = location.ig_img_urls || [];
            const isImageValid = imageUrls.length > 0;

            card.innerHTML = `
                <div class="card-text-content">
                    <strong>${symbolDisplay} ${location.name}</strong><br> 
                    <div class="card-line">${location.country} ${location.city}</div>
                    <div class="card-line">æˆå“¡: ${location.members.join(', ')}</div> 
                    <div class="card-line">ç™¼æ–‡æ—¥æœŸ: ${location.date}</div>
                    <div class="card-line">å‚™è¨»: ${location.note}</div>
                    <a class="card-link" href="${location.ig_post_url}" target="_blank">ğŸ”— IG è²¼æ–‡é€£çµ</a>
                </div>
                
                ${isImageValid 
                    ? `
                    <div 
                        class="image-carousel" 
                        data-location-index="${index}" 
                        data-current-img="0"
                        style="position: relative; cursor: pointer;"
                    >
                        <img 
                            src="${imageUrls[0]}" 
                            alt="${location.name} é è¦½åœ–"
                            style="width: 100%; height: 100%; object-fit: cover;"
                        >
                        <span style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px;">
                            ${imageUrls.length} å¼µ
                        </span>
                    </div>
                    ` 
                    : ''}
            `;
            
            // é»æ“Šå¡ç‰‡æ™‚ï¼Œè§¸ç™¼åœ°åœ–æ¨™è¨˜çš„é»æ“Šäº‹ä»¶
            card.addEventListener('click', () => {
                google.maps.event.trigger(location.marker, 'click');
                map.setCenter(location.marker.getPosition());
                map.setZoom(14); 
            });

            listContainer.appendChild(card);
        });
        
        // å°‡é»æ“Šäº‹ä»¶ç¶å®šåˆ°æ‰€æœ‰è¼ªæ’­å®¹å™¨
        bindCarouselEvents();
    }

    // =================================================================
    // 4. æˆå“¡ç¯©é¸åŠŸèƒ½ 
    // =================================================================
    
    function getAllMembers() {
        const allMembers = new Set();
        locationsData.forEach(location => {
            location.members.forEach(member => {
                allMembers.add(member.trim());
            });
        });
        return Array.from(allMembers).sort();
    }
    
    // ğŸŒŸ æ–°å¢ï¼šå¡«å……åœ‹å®¶ç¯©é¸å™¨ ğŸŒŸ
    function populateCountryFilter() {
        const countryFilter = document.getElementById('country-filter');
        countryFilter.innerHTML = '<option value="">æ‰€æœ‰åœ‹å®¶</option>';

        const uniqueCountries = [...new Set(locationsData.map(loc => loc.country))].sort();

        uniqueCountries.forEach(country => {
            if (country) {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            }
        });
        
        // åˆå§‹åŒ–åœ°å€ç¯©é¸å™¨ï¼Œé¡¯ç¤ºæ‰€æœ‰åœ°é»çš„åŸå¸‚
        populateCityFilter(''); 
    }

    // ğŸŒŸ æ–°å¢ï¼šå¡«å……åœ°å€/åŸå¸‚ç¯©é¸å™¨ (æ ¹æ“šåœ‹å®¶) ğŸŒŸ
    function populateCityFilter(country) {
        const cityFilter = document.getElementById('city-filter');
        cityFilter.innerHTML = '<option value="">æ‰€æœ‰åœ°å€/åŸå¸‚</option>'; 

        let locationsToFilter = locationsData;
        
        // å¦‚æœé¸æ“‡äº†åœ‹å®¶ï¼Œå‰‡åªçœ‹è©²åœ‹å®¶çš„åœ°é»
        if (country) {
            locationsToFilter = locationsData.filter(loc => loc.country === country);
        }
        
        // ç²å–å”¯ä¸€çš„åœ°å€/åŸå¸‚åˆ—è¡¨
        const uniqueCities = [...new Set(locationsToFilter.map(loc => loc.city))].sort();

        uniqueCities.forEach(city => {
            if (city) {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                cityFilter.appendChild(option);
            }
        });
    }
    
    // ğŸŒŸ æ–°å¢ï¼šè™•ç†åœ‹å®¶é¸å–®è®Šæ›´äº‹ä»¶ ğŸŒŸ
    function handleCountryChange() {
        const selectedCountry = document.getElementById('country-filter').value;

        // 1. æ ¹æ“šé¸æ“‡çš„åœ‹å®¶ï¼Œé‡æ–°å¡«å……åœ°å€/åŸå¸‚é¸å–®
        populateCityFilter(selectedCountry);
        
        // 2. åŸ·è¡Œåœ°é»ç¯©é¸
        filterLocations();
    }
    
    // ğŸŒŸ æ–°å¢ï¼šé‡è¨­æ‰€æœ‰ç¯©é¸å™¨ ğŸŒŸ
    function resetFilters() {
        document.getElementById('member-filter').value = 'All';
        document.getElementById('country-filter').value = ''; 
        document.getElementById('city-filter').value = ''; 
        
        // ç¢ºä¿åœ°å€é¸å–®è¢«é‡æ–°å¡«å…… (é¡¯ç¤ºæ‰€æœ‰åœ‹å®¶ä¸‹çš„æ‰€æœ‰åŸå¸‚)
        populateCityFilter('');
        
        filterLocations();
    }

    // ğŸŒŸ æ›´æ–°ï¼šåˆå§‹åŒ–æ‰€æœ‰ç¯©é¸å™¨ ğŸŒŸ
    function initFilters() {
        const memberFilter = document.getElementById('member-filter');
        const members = getAllMembers();
        
        members.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            memberFilter.appendChild(option);
        });
        
        // ç¶å®šæˆå“¡ç¯©é¸çš„äº‹ä»¶
        memberFilter.addEventListener('change', filterLocations);
        
        // åˆå§‹åŒ–åœ‹å®¶å’Œåœ°å€ç¯©é¸å™¨
        populateCountryFilter(); 
        
        // åˆå§‹ç¯©é¸å’Œæ¸²æŸ“ (æ‡‰åœ¨æ‰€æœ‰ç¯©é¸å™¨åˆå§‹åŒ–å¾Œèª¿ç”¨)
        filterLocations();
    }

    // ğŸŒŸ æ›´æ–°ï¼šæ ¸å¿ƒç¯©é¸é‚è¼¯ ğŸŒŸ
    function filterLocations() {
        const selectedMember = document.getElementById('member-filter').value;
        const selectedCountry = document.getElementById('country-filter').value;
        const selectedCity = document.getElementById('city-filter').value;
        let visibleCount = 0;

        locationsData.forEach(location => {
            // æª¢æŸ¥æˆå“¡åŒ¹é…
            const memberMatch = (selectedMember === 'All') || location.members.includes(selectedMember);
            
            // æª¢æŸ¥åœ‹å®¶åŒ¹é…
            const countryMatch = !selectedCountry || location.country === selectedCountry;
            
            // æª¢æŸ¥åœ°å€/åŸå¸‚åŒ¹é…
            const cityMatch = !selectedCity || location.city === selectedCity;
            
            // å¿…é ˆåŒæ™‚æ»¿è¶³æ‰€æœ‰æ¢ä»¶
            const shouldShow = memberMatch && countryMatch && cityMatch;
            
            // æ›´æ–°åœ°åœ–æ¨™è¨˜çš„é¡¯ç¤ºç‹€æ…‹
            location.marker.setVisible(shouldShow);
            
            // æ›´æ–°å´é‚Šæ¬„å¡ç‰‡çš„é¡¯ç¤ºç‹€æ…‹
            const cardElement = document.getElementById(`card-${location.lat}-${location.lng}`);
            if (cardElement) {
                // å¦‚æœé¡¯ç¤ºï¼Œä½¿ç”¨ 'flex' ä¾†ä¿æŒåŸæœ‰çš„ CSS ä½ˆå±€
                cardElement.style.display = shouldShow ? 'flex' : 'none';
            }
            
            if (shouldShow) {
                visibleCount++;
            }
        });
        
        document.getElementById('location-count').textContent = visibleCount;
    }
    // =================================================================
    // 5. è¼‰å…¥ Google Maps å‡½å¼åº« 
    // =================================================================
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDGZujGgC207RjOC7AkNsAj4EmCQWkPt68&callback=loadDataAndInitMap`;
    script.async = true;
    document.head.appendChild(script);

    // å°‡æ–°çš„è¼‰å…¥å‡½å¼æš´éœ²çµ¦å…¨åŸŸç’°å¢ƒ
    window.loadDataAndInitMap = loadDataAndInitMap;
    
</script>

</body>
</html>