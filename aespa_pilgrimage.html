<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·Ÿè‘— aespa ç’°éŠä¸–ç•Œ</title>
    <style>
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f4f4;
        }
        
        #app-container {
            height: 100%; 
            display: flex;
            max-height: 100vh; 
            overflow: hidden; 
        }
        
        #map {
            flex-grow: 1; 
            min-height: 50vh; 
            min-width: 0;
        }
        
        #sidebar {
            width: 40%;
            max-height: 100vh;
            overflow-y: auto; 
            background-color: white;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        
        h2 { color: #5a5a5a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .location-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between; 
            align-items: flex-start; 
        }
        .card-text-content {
            width: 60%; 
            flex-grow: 0; 
            flex-shrink: 0; 
            margin-right: 15px;
            overflow-wrap: break-word; 
            word-wrap: break-word;
        }
        .location-card:hover {
            background-color: #f9f9f9;
        }
        .location-card strong { 
            display: block; 
            font-size: 20px; 
            margin-bottom: 5px; 
            color: #333; 
            overflow-wrap: break-word; 
            word-wrap: break-word;
        }
        .location-card img {
            width: 35%; 
            height: auto;
            object-fit: contain; 
            flex-shrink: 0; 
            border-radius: 4px;
            margin: 0; 
            max-width: 100%;
        }
        .card-line {
            display: block;
            font-size: 18px;
            color: #666;
            line-height: 1.4;
        }

        .card-link{
            display: inline-block;
            margin-top: 0;
            margin-right: 15px;
            font-size: 18px; 
            line-height: 1.4;
        }
        .info-window-content{
            font-size: 20px;
        }
        .info-window-line{
            font-size: 18px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼šé‡å°æ‰‹æ©Ÿè¢å¹• */
        @media (max-width: 768px) {
            #app-container {
                flex-direction: column; 
                height: auto;
            }
            #sidebar {
                width: auto;
                max-height: 45vh; 
                order: 2; 
            }
            #map {
                height: 55vh; 
                order: 1;
            }
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="map"></div>

    <div id="sidebar">
        <h2>è·Ÿè‘— aespa ç’°éŠä¸–ç•Œ (ç›®å‰å…± <span id="location-count">0</span> è™•)</h2>
        
        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <label for="member-filter" style="font-weight: bold;">ä¾æˆå“¡ç¯©é¸ï¼š</label>
            <select id="member-filter" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px;">
                <option value="All">å…¨éƒ¨æˆå“¡</option>
            </select>
            
            <label for="country-filter" style="font-weight: bold; display: block; margin-top: 10px;">åœ‹å®¶:</label>
            <select id="country-filter" onchange="handleCountryChange()" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px;">
                <option value="">æ‰€æœ‰åœ‹å®¶</option>
            </select>

            <label for="city-filter" style="font-weight: bold; display: block; margin-top: 10px;">åœ°å€/åŸå¸‚:</label>
            <select id="city-filter" onchange="filterLocations()" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px;">
                <option value="">æ‰€æœ‰åœ°å€/åŸå¸‚</option>
            </select>

            <button onclick="resetFilters()" style="margin-top: 10px; padding: 8px 15px; width: 100%; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¨­ç¯©é¸</button>
        </div>

        <div id="locations-list">
        </div>
    </div>
</div>

<script>
    // =================================================================
    // å»ºç«‹ Google Maps å°èˆª URL
    // =================================================================
    /**
     * å»ºç«‹ Google Maps å°èˆª URL (ç”¨æ–¼è·³è½‰åˆ°å¤–éƒ¨ App æˆ–ç¶²é )
     * @param {number} lat - ç›®çš„åœ°ç·¯åº¦
     * @param {number} lng - ç›®çš„åœ°ç¶“åº¦
     * @returns {string} - Google Maps Directions URL
     */
    function createNavigationUrl(lat, lng) {
        // ä½¿ç”¨ 'q=' æŸ¥è©¢ç›®çš„åœ°åº§æ¨™ã€‚
        // ç•¶ 'saddr' (èµ·é») ç•™ç©ºæ™‚ï¼ŒGoogle Maps App æœƒè‡ªå‹•ä½¿ç”¨ä½¿ç”¨è€…ç•¶å‰ä½ç½®ã€‚
        return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    }

    /**
     * ç¶å®šè¼ªæ’­å®¹å™¨çš„é»æ“Šäº‹ä»¶ (ç¶­æŒä¸è®Š)
     */
    function bindCarouselEvents() {
        document.querySelectorAll('.image-carousel').forEach(carousel => {
            carousel.addEventListener('click', (event) => {
                event.stopPropagation(); 
                
                const locationIndex = parseInt(carousel.dataset.locationIndex);
                const locationData = locationsData[locationIndex];
                const imageUrls = locationData.ig_img_urls;
                
                if (imageUrls.length <= 1) return; 

                let currentIndex = parseInt(carousel.dataset.currentImg);
                
                currentIndex = (currentIndex + 1) % imageUrls.length;
                
                const imgElement = carousel.querySelector('img');
                imgElement.src = imageUrls[currentIndex];
                
                carousel.dataset.currentImg = currentIndex;
            });
        });
    }

    // =================================================================
    // æˆå“¡é¡è‰²å®šç¾©
    // =================================================================
    const MEMBER_INFO = {
        "Karina": { color: "blue", symbol: "ğŸ’™" }, 
        "Giselle": { color: "pink", symbol: "ğŸŒ™" }, 
        "Winter": { color: "white", symbol: "â­" }, 
        "Ningning": { color: "purple", symbol: "ğŸ¦‹" }, 
        "Default": { color: "orange", symbol: "ğŸ”®" } 
    };
    
    // =================================================================
    // 1. æ•¸æ“šå®£å‘Š
    // =================================================================
    let locationsData = [];

    // =================================================================
    // 2. Google Maps åˆå§‹åŒ–èˆ‡æ¨™è¨˜åŠŸèƒ½
    // =================================================================
    let map;
    let infoWindow; 

    /**
     * è¼‰å…¥æ•¸æ“šä¸¦åˆå§‹åŒ–åœ°åœ–çš„ä¸»è¦å‡½å¼
     */
    async function loadDataAndInitMap() {
        try {
            const response = await fetch('locations.json'); 
            locationsData = await response.json(); 

            infoWindow = new google.maps.InfoWindow(); 
            const bounds = new google.maps.LatLngBounds(); 
            const initialCenter = { lat: 35.6762, lng: 139.6503 }; 
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: initialCenter,
                mapTypeId: 'roadmap',
                styles: [
                    { featureType: "poi", stylers: [{ visibility: "off" }] },
                    { featureType: "transit", elementType: "labels", stylers: [{ visibility: "off" }] }
                ]
            });
            
            // è™•ç†æ¨™è¨˜
            locationsData.forEach(location => {
                addMarker(location);
                bounds.extend({ lat: location.lat, lng: location.lng });
            });
            
            if (locationsData.length > 0) {
                if (locationsData.length === 1) {
                    map.setCenter({ lat: locationsData[0].lat, lng: locationsData[0].lng });
                    map.setZoom(12);
                } else {
                    map.fitBounds(bounds);
                }
            }
            
            google.maps.event.trigger(map, 'resize');
            
            document.getElementById('location-count').textContent = locationsData.length;
            renderSidebarList();
            initFilters(); 

        } catch (error) {
            console.error("âŒ è¼‰å…¥æ•¸æ“šæˆ–åˆå§‹åŒ–åœ°åœ–å¤±æ•—ï¼", error);
        }
    }

    function getMemberInfo(members) {
        if (members.length === 1) {
            const member = members[0].trim();
            return MEMBER_INFO[member] || MEMBER_INFO.Default;
        }
        return MEMBER_INFO.Default;
    }

    /**
     * åœ¨åœ°åœ–ä¸Šæ”¾ç½®ä¸€å€‹æ¨™è¨˜
     * @param {Object} location - åœ°é»æ•¸æ“šç‰©ä»¶
     */
    function addMarker(location) {
        const marker = new google.maps.Marker({
            position: { lat: location.lat, lng: location.lng },
            map: map,
            title: location.name
        });

        const imageUrls = location.ig_img_urls || [];
        const firstImageUrl = imageUrls.length > 0 ? imageUrls[0] : '';
        const isImageValid = firstImageUrl && firstImageUrl !== 'è«‹è‡ªè¡Œå°‹æ‰¾ç…§ç‰‡ URL';
        
        const membersWithSymbols = location.members.map(member => {
            const info = MEMBER_INFO[member.trim()] || MEMBER_INFO.Default;
            return `${info.symbol} ${member.trim()}`;
        }).join('<br>'); 
        
        // ğŸŒŸ å¤–éƒ¨å°èˆª URL
        const navUrl = createNavigationUrl(location.lat, location.lng);

        marker.addListener("click", () => {
            
            const content = `
                <div class="info-window-content">
                    
                    ${isImageValid 
                        ? `<img src="${firstImageUrl}" alt="${location.name} é è¦½åœ–" style="max-width: 250px; height: auto; margin-bottom: 10px; border-radius: 4px;">`
                        : ''}
                    
                    <h4>${location.name}</h4>
                    <div class="info-window-line"><strong>æˆå“¡ï¼š</strong><br> ${membersWithSymbols}</div> 
                    <div class="info-window-line"><strong>ç™¼æ–‡æ—¥æœŸï¼š</strong> ${location.date}</div>
                    <div class="info-window-line"><strong>å‚™è¨»ï¼š</strong> ${location.note}</div>                    
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
            
            const cardElement = document.getElementById(`card-${location.lat}-${location.lng}`);
            if (cardElement) {
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
        
        location.marker = marker;
    }

    // =================================================================
    // 3. å´é‚Šæ¬„åˆ—è¡¨æ¸²æŸ“ (ç°¡åŒ–å¡ç‰‡å…§å®¹)
    // =================================================================
    function renderSidebarList() {
        const listContainer = document.getElementById('locations-list');
        listContainer.innerHTML = ''; 

        locationsData.forEach((location, index) => { 
            if (location.marker && !location.marker.getVisible()) {
                return;
            }

            const card = document.createElement('div');
            card.id = `card-${location.lat}-${location.lng}`; 
            card.className = 'location-card';
            
            const symbolsArray = location.members.map(member => {
                const info = getMemberInfo([member]);
                return info.symbol;
            });
            const symbolDisplay = symbolsArray.join(' '); 
            
            const imageUrls = location.ig_img_urls || [];
            const isImageValid = imageUrls.length > 0;

            // å¤–éƒ¨å°èˆª URL
            const navUrl = createNavigationUrl(location.lat, location.lng);
            
            card.style.display = 'flex';

            card.innerHTML = `
                <div class="card-text-content">
                    <strong>${symbolDisplay} ${location.name}</strong><br> 
                    <div class="card-line">${location.country} ${location.city}</div>
                    <div class="card-line">æˆå“¡: ${location.members.join(', ')}</div> 
                    <div class="card-line">ç™¼æ–‡æ—¥æœŸ: ${location.date}</div>
                    <div class="card-line">å‚™è¨»: ${location.note}</div>

                    <div style="margin-top: 6px;">
                    <a class="card-link" href="${location.ig_post_url}" target="_blank">ğŸ”— è²¼æ–‡é€£çµ</a>
                    <a class="card-link" href="${navUrl}" target="_blank" >ğŸ“ å°èˆª</a>
                    </div>
                </div>
                ${isImageValid 
                    ? `
                    <div 
                        class="image-carousel" 
                        data-location-index="${index}" 
                        data-current-img="0"
                        style="position: relative; cursor: pointer;"
                    >
                        <img 
                            src="${imageUrls[0]}" 
                            alt="${location.name} é è¦½åœ–"
                            style="width: 100%; height: 100%; object-fit: cover;"
                        >
                        <span style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px;">
                            ${imageUrls.length} å¼µ
                        </span>
                    </div>
                    ` 
                    : ''}
            `;
            
            // é»æ“Šå¡ç‰‡ä¸»é«”æ™‚ï¼Œè§¸ç™¼ InfoWindow ä¸¦æ”¾å¤§åœ°åœ–ï¼Œä¸åŸ·è¡Œè¤‡é›œé‚è¼¯
            card.addEventListener('click', (e) => {
                // æª¢æŸ¥é»æ“Šæ˜¯å¦ç™¼ç”Ÿåœ¨ action-button, a æˆ–è¼ªæ’­ä¸Š
                if (e.target.closest('.btn-navigate') || e.target.tagName.toLowerCase() === 'a' || e.target.closest('.image-carousel')) {
                    return; 
                }
                
                // è®“ InfoWindow å½ˆå‡º
                google.maps.event.trigger(location.marker, 'click');

                map.setCenter(location.marker.getPosition());
                map.setZoom(14); 
            });

            listContainer.appendChild(card);
        });
        
        bindCarouselEvents();
    }

    // =================================================================
    // 4. ç¯©é¸åŠŸèƒ½
    // =================================================================

    function getAllMembers() {
        const allMembers = new Set();
        locationsData.forEach(location => {
            location.members.forEach(member => {
                allMembers.add(member.trim());
            });
        });
        return Array.from(allMembers).sort();
    }
    
    function populateCountryFilter() {
        const countryFilter = document.getElementById('country-filter');
        countryFilter.innerHTML = '<option value="">æ‰€æœ‰åœ‹å®¶</option>';

        const uniqueCountries = [...new Set(locationsData.map(loc => loc.country))].sort();

        uniqueCountries.forEach(country => {
            if (country) {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            }
        });
        
        populateCityFilter(''); 
    }

    function populateCityFilter(country) {
        const cityFilter = document.getElementById('city-filter');
        cityFilter.innerHTML = '<option value="">æ‰€æœ‰åœ°å€/åŸå¸‚</option>'; 

        let locationsToFilter = locationsData;
        
        if (country) {
            locationsToFilter = locationsData.filter(loc => loc.country === country);
        }
        
        const uniqueCities = [...new Set(locationsToFilter.map(loc => loc.city))].sort();

        uniqueCities.forEach(city => {
            if (city) {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                cityFilter.appendChild(option);
            }
        });
    }
    
    function handleCountryChange() {
        const selectedCountry = document.getElementById('country-filter').value;
        populateCityFilter(selectedCountry);
        filterLocations();
    }
    
    function resetFilters() {
        document.getElementById('member-filter').value = 'All';
        document.getElementById('country-filter').value = ''; 
        document.getElementById('city-filter').value = ''; 
        
        populateCityFilter('');
        
        filterLocations();
    }

    function initFilters() {
        const memberFilter = document.getElementById('member-filter');
        const members = getAllMembers();
        
        members.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            memberFilter.appendChild(option);
        });
        
        memberFilter.addEventListener('change', filterLocations);
        
        populateCountryFilter(); 
        
        filterLocations();
    }

    function filterLocations() {
        const selectedMember = document.getElementById('member-filter').value;
        const selectedCountry = document.getElementById('country-filter').value;
        const selectedCity = document.getElementById('city-filter').value;
        let visibleCount = 0;

        infoWindow.close();


        locationsData.forEach(location => {
            const memberMatch = (selectedMember === 'All') || location.members.includes(selectedMember);
            const countryMatch = !selectedCountry || location.country === selectedCountry;
            const cityMatch = !selectedCity || location.city === selectedCity;
            
            const shouldShow = memberMatch && countryMatch && cityMatch;
            
            location.marker.setVisible(shouldShow);
            
            const cardElement = document.getElementById(`card-${location.lat}-${location.lng}`);
            if (cardElement) {
                cardElement.style.display = shouldShow ? 'flex' : 'none';
            }
            
            if (shouldShow) {
                visibleCount++;
            }
        });
        
        document.getElementById('location-count').textContent = visibleCount;
    }

    // =================================================================
    // 5. è¼‰å…¥ Google Maps å‡½å¼åº« 
    // =================================================================
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDGZujGgC207RjOC7AkNsAj4EmCQWkPt68&callback=loadDataAndInitMap`; 
    script.async = true;
    document.head.appendChild(script);

    window.loadDataAndInitMap = loadDataAndInitMap;
    
</script>

</body>
</html>